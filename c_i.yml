trigger:
  branches:
    include:
    - t3-mirror-cache
variables:
  PYTHON_VERSION: 3.8
  CONDA_ENV: test-env
  TASK: bdist
jobs:
###########################################
- job: Windows
###########################################
  pool:
    vmImage: 'vs2017-win2016'
  steps:
  - powershell: |
      Write-Host "##vso[task.prependpath]$env:CONDA\Scripts"
      Write-Host "##vso[task.setvariable variable=AZURE]true"
    displayName: 'Set Variables'
  - task: Cache@2
    inputs:
      key: "opencl.windows" | "amd.cpu" | "v3.0.130.135" | "0"
      path: $(Pipeline.Workspace)/opencl_windows-amd_cpu-v3_0_130_135
      cacheHitVar: OPENCL_INSTALLER_FOUND
    condition: eq(variables.TASK, 'bdist')
    displayName: 'Cache OpenCL'
  - script: |
      cmd /c "powershell -ExecutionPolicy Bypass -File %BUILD_SOURCESDIRECTORY%/.ci/d_o.ps1"
    condition: and(eq(variables.TASK, 'bdist'), condition: ne(variables.OPENCL_INSTALLER_FOUND, 'true'))
    displayName: 'Download OpenCL'
  - script: |
      cmd /c "powershell -ExecutionPolicy Bypass -File %BUILD_SOURCESDIRECTORY%/.ci/i_o.ps1"
    condition: eq(variables.TASK, 'bdist')
    displayName: 'Install OpenCL'
  - script: |
      cmd /c "conda init powershell"
      cmd /c "powershell -ExecutionPolicy Bypass -File %BUILD_SOURCESDIRECTORY%/.ci/t_p.ps1"
    displayName: 'Test'
